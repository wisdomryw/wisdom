!function(t,e,i,n){var s=i.scripts,o=s[s.length-1].src,a="&ac3&ai&aiff&ani&asf&au&avi&bat&bin&bmp&bup&cab&cal&cat&cur&dat&dcr&der&dic&dll&doc&docx&dvd&dwg&dwt&fon&gif&hlp&hst&html&ico&ifo&inf&ini&java&jif&jpg&log&m4a&mmf&mmm&mov&mp2&mp2v&mp3&mp4&mpeg&msp&pdf&png&ppt&pptx&psd&ra&rar&reg&rtf&theme&Thumbs&tiff&tlb&ttf&txt&vob&wav&wma&wmv&wpl&wri&xls&xlsx&xml&xsl&zip&exe&",l={uploadAddress:"",retryMigrateAddress:"",chunkSize:5242880,isRename:!1,fileSavePath:""},u=function(t,e){this.pluginId="",this.pluginBasePath="",this.$ele=t,this.options=e,this.taskQueue=[],this.taskIndex=-1,this.currentUploadIndex=0,this.init()};u.prototype={constructor:u,init:function(){this.getPluginBasePath(),this.renderHtml(),this.bindEvent()},guidGenerator:function(){var t=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)};return t()+t()+"-"+t()+"-"+t()+"-"+t()+"-"+t()+t()+t()},getPluginBasePath:function(){var t=o.substring(0,o.lastIndexOf("/"));return this.pluginBasePath=t.substring(0,t.lastIndexOf("/")+1),this.pluginBasePath},splitStr:function(t,e){var i=/[^\x00-\xff]/g;if(t.replace(i,"mm").length<=e)return t;for(var n=Math.floor(e/2),s=n;s<t.length;s++)if(t.substr(0,s).replace(i,"mm").length>=e)return t.substr(0,s)+"...";return t},bytesToSize:function(t){if(0===t)return"0 B";var e=1024,i=["B","KB","MB","GB","TB","PB","EB","ZB","YB"],n=Math.floor(Math.log(t)/Math.log(e));return(t/Math.pow(e,n)).toPrecision(3)+" "+i[n]},renderHtml:function(){this.pluginId=this.guidGenerator();var t=(this.options,"");t='<div style="width:100%; border:1px #ddd solid; font-size:12px; position:relative" id="httpupload-plugin-'+this.pluginId+'"><div style="width:100%; border-bottom:1px #ddd solid; height:28px; line-height:28px;"><input id="httpupload-plugin-file-button-'+this.pluginId+'" type="button" style="border:1px #ddd solid;background:#fff; margin:4px;" value="上传"/><input id="httpupload-plugin-file-input-'+this.pluginId+'" type="file" style="display:none;" /></div><div id="httpupload-plugin-container-'+this.pluginId+'"></div><div style="clear:both"></div></div>',this.$ele.html(t)},complete:function(e,i,n,s,o){if(200==e.status){t("#httpupload-plugin-uploadtip-"+n+"-"+s).html("上传成功");var a=JSON.parse(e.responseText);o.taskQueue[s].migrateFileName=a.migrateFileName,o.taskQueue[s].fileName=a.originFileName,o.taskQueue[s].stop=!0,o.uploadNext()}else{t("#httpupload-plugin-uploadtip-"+n+"-"+s).html("上传失败");var l=t("#httpupload-plugin-controlicon-"+n+"-"+s).length;if(0==l){var u='<img id="httpupload-plugin-controlicon-'+n+"-"+s+'" src="'+o.pluginBasePath+'images/start.png" style="float: right;" />';t("#httpupload-plugin-controlinfo-"+n+"-"+s).append(u)}t("#httpupload-plugin-controlicon-"+n+"-"+s).off("click"),t("#httpupload-plugin-controlicon-"+n+"-"+s).on("click",function(){t(this).remove(),601==e.status?o.retryMigrate(s,o):o.doUplaod(o.taskQueue[s].uploadFile,o.taskQueue[s].fileSessionId,o.progress,o.complete)})}},retryMigrate:function(e,i){var n=i.taskQueue[e].fileSessionId,s=i.options.retryMigrateAddress,o=[];o.push(n);var a={fileSessionIdArray:o},l=JSON.stringify(a);t.ajax({type:"POST",dataType:"json",url:s,data:l,success:function(i){var s=i[0];s.success&&t("#httpupload-plugin-uploadtip-"+n+"-"+e).html("上传成功")}})},progress:function(e,i,n){console.log("上传百分比： "+Math.floor(100*e)+"%"),t("#httpupload-plugin-progressvalue-"+i+"-"+n).css("width",Math.floor(100*e)+"%")},bindEvent:function(){var e=this;t("#httpupload-plugin-file-button-"+e.pluginId).on("click",function(){t("#httpupload-plugin-file-input-"+e.pluginId).click()}),t("#httpupload-plugin-file-input-"+this.pluginId).on("change",function(){var i=t("#httpupload-plugin-file-input-"+e.pluginId).get(0).files[0];t("#httpupload-plugin-file-input-"+e.pluginId).val("");var n=e.guidGenerator();e.addUpload(i,n,e.progress,e.complete)})},uploadNext:function(){for(;this.currentUploadIndex!=this.taskQueue.length-1;)if(this.currentUploadIndex=this.currentUploadIndex+1,null!=this.taskQueue[this.currentUploadIndex]){this.taskQueue[this.currentUploadIndex].stop=!1,this.doUplaod(this.taskQueue[this.currentUploadIndex].uploadFile,this.taskQueue[this.currentUploadIndex].fileSessionId,this.progress,this.complete);break}},addUpload:function(t,e,i,n){this.taskIndex++,this.addUploadHtml(e,t.name,this.taskIndex),this.bindUploadHtmlEvent(e,this.taskIndex);var s=t.name;this.taskQueue[this.taskIndex]={stop:!0,isDelete:!1,finishProgress:0,uploadFile:t,offset:0,fileName:s,migrateFileName:"",fileSessionId:e,responseStatus:""},this.isTaskUploading()||(this.currentUploadIndex=this.taskIndex,this.taskQueue[this.currentUploadIndex].stop=!1,this.doUplaod(t,e,i,n))},isTaskUploading:function(){for(var t=0;t<this.taskQueue.length;t++)if(null!=this.taskQueue[t]){var e=this.taskQueue[t].stop;if(!e)return!0}return!1},getIconNameByFileType:function(t){if(null!=t){var e=t.substring(t.lastIndexOf(".")+1);return e=e.toLowerCase(),-1!=a.indexOf("&"+e+"&")?e+".png":"unk.png"}return"unk.png"},addUploadHtml:function(e,i,n){var s="",o=this.pluginBasePath+"images/"+this.getIconNameByFileType(i),i=this.splitStr(i,26);s='<div style="width:260px; height:45px; background:#f5f5f5; border:1px #ddd solid; padding:10px; float:left; margin:5px;" id="httpupload-plugin-uploadcontrol-'+e+"-"+n+'"><div style="float:left"><img src="'+o+'" width="40px" height="40px"/></div><div style="float:left; width:210px;"><div style="margin:5px; padding:0px; width:100%; height:15px;"><div style="float:left;" id="httpupload-plugin-filename-'+e+"-"+n+'">'+i+'</div><div style="float:right;"><a href="#" style=" text-decoration:none; color:#1597DD" id="httpupload-plugin-delete-'+e+"-"+n+'">删除</a></div></div><div style="margin:5px; padding:0px;  width:100%; height:15px;" id="httpupload-plugin-controlinfo-'+e+"-"+n+'"><div style="width:70px; height:13px; border:1px #ddd solid; float:left" id="httpupload-plugin-progressbar-'+e+"-"+n+'"><div style="width:0%; height:13px; background:#390" id="httpupload-plugin-progressvalue-'+e+"-"+n+'"></div></div></div></div></div>',t("#httpupload-plugin-container-"+this.pluginId).append(s)},bindUploadHtmlEvent:function(e,i){var n=this;t("#httpupload-plugin-delete-"+e+"-"+i).on("click",function(){t("#httpupload-plugin-uploadcontrol-"+e+"-"+i).remove(),n.deleteUpload(i)})},renderTipInfo:function(e,i){var n=t("#httpupload-plugin-uploadtip-"+e+"-"+this.currentUploadIndex).length;if(0==n){var s=this.bytesToSize(i.size),o='<font style="color:#999;margin-left: 5px; margin-right:10px;">'+s+'</font><font style="color:#390;" id="httpupload-plugin-uploadtip-'+e+"-"+this.currentUploadIndex+'">上传中</font>';t("#httpupload-plugin-controlinfo-"+e+"-"+this.currentUploadIndex).append(o)}else t("#httpupload-plugin-uploadtip-"+e+"-"+this.currentUploadIndex).html("上传中")},doUplaod:function(t,e,i,n){this.renderTipInfo(e,t);var s=this,o=s.options.uploadAddress,a=!1,l=null,u=null,d=this.taskQueue[this.currentUploadIndex].offset,p=function(){var l=null,r=d,h=Math.min(d+s.options.chunkSize,t.size)-1,f=(t.slice||t.mozSlice||t.webkitSlice).call(t,r,h+1);if(!(f&&f.size>0))return void alert("Chunk size is 0");if(u=new XMLHttpRequest,h===t.size-1){var c=JSON.stringify({fileSavePath:s.options.fileSavePath,fileSessionId:e,isRename:s.options.isRename});u.open("POST",o+(o.indexOf("?")>-1?"&":"?")+"redirectParam="+c,!0)}else u.open("POST",o,!0);u.upload.addEventListener("progress",function(e){a||(s.taskQueue[s.currentUploadIndex].finishProgress=Math.floor((r+e.loaded)/t.size*100),i((r+e.loaded)/t.size,s.taskQueue[s.currentUploadIndex].fileSessionId,s.currentUploadIndex))}),u.addEventListener("load",function(){return a?void 0:s.taskQueue[s.currentUploadIndex].stop?void(s.taskQueue[s.currentUploadIndex].isDelete&&(s.taskQueue[s.currentUploadIndex]=null,s.uploadNext())):void(u.readyState>=4&&(s.taskQueue[s.currentUploadIndex].offset=h+1,s.taskQueue[s.currentUploadIndex].responseStatus=u.status,201===u.status?(d=h+1,l=setTimeout(p,1)):n(u,t.size,s.taskQueue[s.currentUploadIndex].fileSessionId,s.currentUploadIndex,s)))}),u.addEventListener("error",function(){n(u,t.size,s.taskQueue[s.currentUploadIndex].fileSessionId,s.currentUploadIndex,s)}),u.setRequestHeader("Content-Type","application/octet-stream"),u.setRequestHeader("Content-Disposition",'attachment; filename="'+encodeURIComponent(t.name)+'"'),u.setRequestHeader("X-Content-Range","bytes "+r+"-"+h+"/"+t.size),u.setRequestHeader("X-Session-ID",e),u.send(f)};return l=setTimeout(p,1),{abort:function(){a=!0,null!==l&&(clearTimeout(l),l=null);try{u.abort()}catch(t){}},pause:function(){this.abort(),a=!1},resume:function(){p()}}},deleteUpload:function(t){null==this.taskQueue[t]||this.taskQueue[t].stop?this.taskQueue[t].stop&&(this.taskQueue[t]=null):(this.taskQueue[t].isDelete=!0,this.taskQueue[t].stop=!0)},isFinishedAllTasks:function(){var t={finishStatus:!0,description:"全部上传完成！"};if(this.taskQueue.length>0)for(var e=0;e<this.taskQueue.length;e++){var i=this.taskQueue[e];null!=i&&200!=i.responseStatus&&(t.finishStatus=!1,t.description="没有全部完成！")}else t.description="无上传任务！";return t},getUploadTasksDetail:function(){var t={},e=[];if(this.taskQueue.length>0)for(var i=0;i<this.taskQueue.length;i++){var n=this.taskQueue[i];if(null!=n){var s={};s.fileSessionId=n.fileSessionId,s.fileName=n.fileName,s.migrateFileName=n.migrateFileName,s.offset=n.offset,s.stop=n.stop,s.finishProgress=n.finishProgress,s.responseStatus=n.responseStatus,e.push(s)}}else t.description="没有上传任务！";return t.uploadTasksDetail=e,t.description="返回成功！",t}},t.fn.httpUploadPlugin=function(e){return e=t.extend(l,e||{}),new u(t(this),e)}}(jQuery,window,document);